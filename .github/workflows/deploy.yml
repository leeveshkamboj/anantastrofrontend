name: Deploy Frontend

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  deploy-frontend:
    name: Deploy Frontend to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/deploy_key \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              "echo 'SSH connection successful'"

      - name: Deploy Frontend
        run: |
          ssh -i ~/.ssh/deploy_key \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            echo "üöÄ Starting frontend deployment..."

            cd ~/anantastrofrontend || exit 1

            if [ -d ".git" ]; then
              echo "üì• Pulling latest frontend code..."
              git pull origin master || true
            else
              echo "‚ö†Ô∏è Frontend directory is not a git repo"
            fi

            cd ~

            echo "üî® Building frontend..."
            docker compose build frontend

            echo "üõë Stopping frontend container..."
            docker compose stop frontend || true
            docker compose rm -f frontend || true

            echo "üöÄ Starting frontend..."
            docker compose up -d frontend

            echo "‚è≥ Waiting for frontend to stabilize..."
            sleep 15

            echo "üìä Frontend status:"
            docker compose ps frontend

            echo "üìã Frontend logs:"
            docker compose logs --tail=50 frontend

            echo "‚úÖ Frontend deployment completed!"
          EOF

      - name: Verify Frontend
        run: |
          ssh -i ~/.ssh/deploy_key \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            echo "üîç Verifying frontend..."

            if docker compose ps frontend | grep -q "Up"; then
              echo "‚úÖ Frontend container is running"
            else
              echo "‚ùå Frontend container is NOT running"
              docker compose ps frontend
              exit 1
            fi

            curl -f http://localhost >/dev/null 2>&1 \
              && echo "‚úÖ Frontend responding" \
              || echo "‚ö†Ô∏è Frontend not responding"
          EOF
